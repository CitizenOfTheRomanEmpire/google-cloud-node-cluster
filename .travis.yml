language: node_js
node_js:
- '6.9'

cache:
  directories:
  - node_modules

before_install:
- openssl aes-256-cbc -K $encrypted_713c90b2403d_key -iv $encrypted_713c90b2403d_iv -in environment/private.tar.enc -out environment/private.tar -d
- mkdir environment/private && tar xvf environment/private.tar -C environment/private

before_script:
- export NODE_ENV="test"
- export VERSION="$(node -p -e "require('./package').version")-$TRAVIS_BUILD_NUMBER"
- export MESSAGE="$VERSION \"$(git log --format=%B --no-merges -n 1)\""
- export VERSION="${VERSION//[^[:alnum:]^-]}"

- if [[ "$TRAVIS_BRANCH" = "master" ]]; then
    export ENVIRONMENT="prod";
  fi
- if [[ "$TRAVIS_BRANCH" = "develop" ]]; then
    export ENVIRONMENT="stag";
  fi

- if [[ "$ENVIRONMENT" ]]; then
    export PROJECT="$(node -p -e "require('./environment/private/travis.server.$ENVIRONMENT.key').project_id")";
  fi

- if [[ "$PROJECT" && "$MESSAGE" == *"[deploy]"* ]]; then
    export DEPLOY=true;
  fi

deploy:
- provider: gae
  skip_cleanup: true
  keyfile: environment/private/travis.server.$ENVIRONMENT.key.json
  config: server.$ENVIRONMENT.yml
  project: $PROJECT
  version: $VERSION
  on:
    all_branches: true
    condition: $DEPLOY
